<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IGAME公告编辑器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }
        
        .panel {
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            padding: 20px;
            height: 100%;
        }
        
        .panel-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .panel-title i {
            margin-right: 8px;
            color: #3498db;
        }
        
        textarea {
            width: 100%;
            height: 300px;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 12px;
            font-size: 14px;
            resize: vertical;
            line-height: 1.5;
            margin-bottom: 15px;
        }
        
        .format-bar {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }
        
        button {
            padding: 8px 12px;
            background: #f0f2f5;
            border: 1px solid #e0e3e7;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        button:hover {
            background: #e9f0f7;
            border-color: #cfd8dc;
        }
        
        button:active {
            transform: translateY(1px);
        }
        
        .special-controls {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .control-group {
            margin-bottom: 12px;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }
        
        .control-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .control-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .preview {
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 13px;
            background: white;
            color: #333;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            height: 300px;
            overflow: auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .header h1 {
            font-size: 28px;
            color: #2c3e50;
            margin-bottom: 8px;
        }
        
        .header p {
            color: #7f8c8d;
            max-width: 700px;
            margin: 0 auto;
        }
        
        .instructions {
            background: #e8f4fc;
            border-left: 4px solid #3498db;
            padding: 12px;
            border-radius: 0 4px 4px 0;
            margin: 15px 0;
            font-size: 14px;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
            border: none;
        }
        
        .btn-primary:hover {
            background: #2980b9;
        }

        .copy-btn {
            background: #3498db;
            color: white;
            border: none;
            width: 100%;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .copy-btn:hover {
            background: #2980b9;
        }
        
        .sample-text {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 12px;
            font-size: 13px;
            margin: 15px 0;
        }
        
        .color-picker {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .color-option {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            border: 1px solid #ddd;
        }
        
        .color-option:hover {
            transform: scale(1.1);
            border-color: #333;
        }
        
        .color-option.selected {
            border: 2px solid #333;
            transform: scale(1.1);
        }
        
        .generate-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            font-weight: 600;
            margin-top: 15px;
            width: 100%;
            font-size: 16px;
        }
        
        .generate-btn:hover {
            background: #219653;
        }
        
        /* 按钮组容器，用于并排显示清空和导入按钮 */
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .clear-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            font-weight: 500;
            flex: 1;
        }
        
        .clear-btn:hover {
            background: #c0392b;
        }

        .import-btn {
            background: #e67e22;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            font-weight: 500;
            flex: 1;
        }
        
        .import-btn:hover {
            background: #d35400;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .required {
            color: #e74c3c;
            margin-left: 3px;
        }
        
        .history-controls {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        
        .history-btn {
            background: #f0f2f5;
            border: 1px solid #e0e3e7;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
        }
        
        .history-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .hint {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 3px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>IGAME公告编辑器</h1>
        <p>将普通文本转换为IGAME公告需求的特殊文本，工作室内部使用</p>
        <p>编辑器使用过程中需要维护、发现BUG等问题找：秦绪亮</p>
    </div>
    
    <div class="container">
        <div class="panel">
            <div class="panel-title">
                文本输入
            </div>
            
            <div class="instructions">
                <strong>修改现有公告方法：</strong>
                <div style="font-size: 13px; margin-top:5px; color:#555;">
                    将旧的JSON代码直接粘贴到下方大输入框中，然后点击底部的 <span style="color:#e67e22; font-weight:bold;">"解析 JSON (导入)"</span> 按钮，即可恢复到编辑状态。
                </div>
            </div>
            
            <div class="form-group">
                <label>缩略图标题 <span class="required">*</span></label>
                <input type="text" id="thumbTitle" placeholder="例如：版本更新公告">
            </div>
            
            <div class="form-group">
                <label>缩略图网址 <span class="required">*</span></label>
                <input type="text" id="thumbUrl" placeholder="例如：http://example.com/title.png">
            </div>
            
            <div class="form-group">
                <label>标题内容 <span class="required">*</span></label>
                <input type="text" id="topTitle" placeholder="例如：内部测试版本更新公告">
            </div>
            
            <div class="form-group">
                <label>重要公告 <span class="required">*</span></label>
                <select id="importantOption">
                    <option value="true">是</option>
                    <option value="false">否</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>显示红点 <span class="required">*</span></label>
                <select id="showMarkOption">
                    <option value="true">是</option>
                    <option value="false">否</option>
                </select>
            </div>
            
            <textarea id="inputText" placeholder="在此输入文本内容，或者粘贴旧的JSON代码用于导入...">请输入文本</textarea>
            
            <div class="history-controls">
                <button class="history-btn" id="undoBtn">撤销 (Ctrl+Z)</button>
                <button class="history-btn" id="redoBtn" disabled>重做 (Ctrl+Y)</button>
            </div>
            
            <div class="format-bar">
                <button data-format='align="center"'>居中</button>
                <button data-format='align="left"'>左对齐</button>
                <button data-format='align="right"'>右对齐</button>
                <button data-format="color">颜色</button>
            </div>
            
            <div class="format-bar">
                <button data-format="b">加粗</button>
                <button data-format="i">斜体</button>
                <button data-format="u">下划线</button>
                <button data-format="s">删除线</button>
            </div>
            
            <div class="format-bar">
                <button data-format="sup">上标</button>
                <button data-format="sub">下标</button>
                <button id="linkButton">添加链接</button>
                <button id="imageButton">添加图片</button>
            </div>
            
            <div class="special-controls">
                <div class="control-group">
                    <label for="linkUrl">链接地址:</label>
                    <input type="text" id="linkUrl" placeholder="https://example.com" value="http://www.baidu.com">
                </div>
                
                <div class="control-group">
                    <label for="imageUrl">图片地址:</label>
                    <input type="text" id="imageUrl" placeholder="https://example.com/image.png" value="http://10.236.13.23:8088/texture/10.png">
                </div>
                
                <div class="control-group">
                    <label>颜色选择:</label>
                    <div class="color-picker">
                        <div class="color-option" style="background-color: #FF0000" data-color="#FF0000"></div>
                        <div class="color-option" style="background-color: #0000FF" data-color="#0000FF"></div>
                        <div class="color-option" style="background-color: #00FF00" data-color="#00FF00"></div>
                        <div class="color-option" style="background-color: #FFFF00" data-color="#FFFF00"></div>
                        <div class="color-option" style="background-color: #FF00FF" data-color="#FF00FF"></div>
                        <div class="color-option" style="background-color: #00FFFF" data-color="#00FFFF"></div>
                        <div class="color-option" style="background-color: #FFFFFF" data-color="#FFFFFF"></div>
                        <div class="color-option" style="background-color: #000000" data-color="#000000"></div>
                        <div class="color-option" style="background-color: #FFA500" data-color="#FFA500"></div>
                        <div class="color-option" style="background-color: #800080" data-color="#800080"></div>
                        <div class="color-option" style="background-color: #008080" data-color="#008080"></div>
                        <div class="color-option" style="background-color: #808080" data-color="#808080"></div>
                    </div>
                </div>
                
                <button id="addLinkButton" class="btn-primary" style="width: 100%;">确认添加链接</button>
                
                <button id="generateButton" class="generate-btn">生成结果</button>
                
                <div class="btn-group">
                    <button id="importButton" class="import-btn">解析 JSON (导入)</button>
                    <button id="clearButton" class="clear-btn">清空输入</button>
                </div>
            </div>
        </div>
        
        <div class="panel">
            <div class="panel-title">生成结果</div>
            <div class="instructions">
                <strong>输出格式说明：</strong>
                <ul>
                    <li>&nbsp;&nbsp;&nbsp;输出纯文本JSON，不带任何格式</li>
                    <li>&nbsp;&nbsp;&nbsp;换行符正确显示为\n</li>
                    <li>&nbsp;&nbsp;&nbsp;图片可插入到文本任意位置</li>
                </ul>
            </div>
            
            <button id="copyButton" class="copy-btn">复制结果</button>

            <div class="preview" id="preview"></div>
            <div class="instructions" style="margin-top: 15px;">
                <strong>使用提示：</strong>直接复制上述文字到公告后台的文本框。
            </div>
        </div>
    </div>

    <div class="sample-text" style="margin-top: 20px;">
        <strong>输出示例：</strong>
        <pre>{
    "titleText" : "版本更新公告",
    "titleTexture" : "http://...",
    "important" : true,
    "showMark" : true,
    "headText": "内部测试版本更新公告",
    "cells" : [ ... ]
}</pre>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const inputText = document.getElementById('inputText');
            const preview = document.getElementById('preview');
            const linkUrl = document.getElementById('linkUrl');
            const imageUrl = document.getElementById('imageUrl');
            const addLinkButton = document.getElementById('addLinkButton');
            const linkButton = document.getElementById('linkButton');
            const imageButton = document.getElementById('imageButton');
            const generateButton = document.getElementById('generateButton');
            const clearButton = document.getElementById('clearButton');
            const importButton = document.getElementById('importButton'); // 新增导入按钮
            const undoBtn = document.getElementById('undoBtn');
            const redoBtn = document.getElementById('redoBtn');
            const copyButton = document.getElementById('copyButton');
            
            // 必填字段
            const thumbTitle = document.getElementById('thumbTitle');
            const thumbUrl = document.getElementById('thumbUrl');
            const topTitle = document.getElementById('topTitle');
            const importantOption = document.getElementById('importantOption');
            const showMarkOption = document.getElementById('showMarkOption');
            
            let selectedColor = "#FF0000";
            
            // 历史记录栈 (保持不变)
            const history = {
                states: [],
                currentIndex: -1,
                maxHistory: 50,
                saveState: function() {
                    const state = {
                        inputText: inputText.value,
                        thumbTitle: thumbTitle.value,
                        thumbUrl: thumbUrl.value,
                        topTitle: topTitle.value,
                        importantOption: importantOption.value,
                        showMarkOption: showMarkOption.value
                    };
                    if (this.currentIndex < this.states.length - 1) {
                        this.states = this.states.slice(0, this.currentIndex + 1);
                    }
                    this.states.push(state);
                    if (this.states.length > this.maxHistory) {
                        this.states.shift();
                    }
                    this.currentIndex = this.states.length - 1;
                    this.updateButtons();
                },
                undo: function() {
                    if (this.currentIndex > 0) {
                        this.currentIndex--;
                        this.restoreState();
                        this.updateButtons();
                    }
                },
                redo: function() {
                    if (this.currentIndex < this.states.length - 1) {
                        this.currentIndex++;
                        this.restoreState();
                        this.updateButtons();
                    }
                },
                restoreState: function() {
                    const state = this.states[this.currentIndex];
                    if (state) {
                        inputText.value = state.inputText;
                        thumbTitle.value = state.thumbTitle;
                        thumbUrl.value = state.thumbUrl;
                        topTitle.value = state.topTitle;
                        importantOption.value = state.importantOption;
                        showMarkOption.value = state.showMarkOption;
                    }
                },
                updateButtons: function() {
                    undoBtn.disabled = this.currentIndex <= 0;
                    redoBtn.disabled = this.currentIndex >= this.states.length - 1;
                }
            };
            
            history.saveState();
            
            let saveTimeout;
            function saveStateDebounced() {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => {
                    history.saveState();
                }, 300);
            }
            
            // 监听所有输入变化
            inputText.addEventListener('input', saveStateDebounced);
            thumbTitle.addEventListener('input', saveStateDebounced);
            thumbUrl.addEventListener('input', saveStateDebounced);
            topTitle.addEventListener('input', saveStateDebounced);
            importantOption.addEventListener('change', saveStateDebounced);
            showMarkOption.addEventListener('change', saveStateDebounced);
            
            undoBtn.addEventListener('click', () => history.undo());
            redoBtn.addEventListener('click', () => history.redo());
            
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'z') { e.preventDefault(); history.undo(); }
                else if (e.ctrlKey && e.key === 'y') { e.preventDefault(); history.redo(); }
            });
            
            // 颜色选择器
            document.querySelectorAll('.color-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedColor = this.getAttribute('data-color');
                });
            });
            
            // 格式按钮
            document.querySelectorAll('[data-format]').forEach(button => {
                button.addEventListener('click', function() {
                    const format = this.getAttribute('data-format');
                    if (format === 'color') {
                        if (getSelectionText()) wrapSelection(`color=${selectedColor}`);
                        else alert('请先选中需要添加颜色的文本');
                        return;
                    }
                    wrapSelection(format);
                    saveStateDebounced();
                });
            });
            
            linkButton.addEventListener('click', () => {
                if (getSelectionText()) document.getElementById('linkUrl').focus();
                else alert('请先选中需要添加链接的文本');
            });
            
            addLinkButton.addEventListener('click', () => {
                const url = linkUrl.value.trim();
                const selectedText = getSelectionText();
                if (!url || !selectedText) { alert('请输入链接并选中文字'); return; }
                replaceSelection(`<link=${url}>${selectedText}</link>`);
                saveStateDebounced();
            });
            
            imageButton.addEventListener('click', () => {
                const url = imageUrl.value.trim();
                if (!url) { alert('请输入图片地址'); return; }
                replaceSelection(`{ "_type" : 2, "_content" : "${url}" }`);
                saveStateDebounced();
            });

            // ==========================================
            // 新增功能：解析 JSON (导入)
            // ==========================================
            importButton.addEventListener('click', function() {
                const rawInput = inputText.value.trim();
                if (!rawInput) {
                    alert('请先在输入框中粘贴 JSON 代码');
                    return;
                }

                try {
                    const data = JSON.parse(rawInput);

                    // 1. 填充头部表单
                    if (data.titleText) thumbTitle.value = data.titleText;
                    if (data.titleTexture) thumbUrl.value = data.titleTexture;
                    if (data.headText) topTitle.value = data.headText;
                    if (data.important !== undefined) importantOption.value = data.important.toString();
                    if (data.showMark !== undefined) showMarkOption.value = data.showMark.toString();

                    // 2. 解析 Body 内容
                    let restoredBody = "";
                    if (data.cells && Array.isArray(data.cells)) {
                        const cellParts = [];
                        data.cells.forEach(cell => {
                            if (cell._type === 2) {
                                // 还原图片格式
                                cellParts.push(`{ "_type" : 2, "_content" : "${cell._content}" }`);
                            } else if (cell._type === 1) {
                                // 还原文本内容
                                cellParts.push(cell._content);
                            }
                        });
                        // 用换行符拼接所有单元
                        restoredBody = cellParts.join('\n');
                    }

                    // 3. 填回输入框
                    inputText.value = restoredBody;
                    
                    alert('导入成功！您可以开始编辑了。');
                    saveStateDebounced(); // 保存到历史记录

                } catch (e) {
                    console.error(e);
                    alert('JSON 格式错误，无法解析。\n请确保粘贴的是完整的 JSON 代码。');
                }
            });
            
            // 生成结果
            generateButton.addEventListener('click', function() {
                if (!thumbTitle.value.trim() || !thumbUrl.value.trim() || !topTitle.value.trim()) {
                    alert('请填写所有带 * 的必填项');
                    return;
                }
                
                const important = importantOption.value === 'true';
                const showMark = showMarkOption.value === 'true';
                const textContent = inputText.value;
                const cells = [];
                
                // 按换行符分割，但保留空行逻辑
                const lines = textContent.split(/\n/);
                let currentCell = null;
                
                for (let i = 0; i < lines.length; i++) {
                    let line = lines[i];
                    
                    if (line.trim().startsWith('{ "_type" : 2, "_content" :')) {
                        // 宽松匹配图片JSON字符串
                        const imgMatch = line.match(/"_content"\s*:\s*"([^"]+)"/);
                        if (imgMatch && imgMatch[1]) {
                            if (currentCell) {
                                cells.push(currentCell);
                                currentCell = null;
                            }
                            cells.push({ "_type": 2, "_content": imgMatch[1] });
                        }
                    } else {
                        // 【修复点1】防止双重转义，确保输入框里的 \n 变成真正的换行
                        line = line.replace(/\\n/g, '\n');

                        if (!currentCell) {
                            currentCell = { "_type": 1, "_content": line };
                        } else {
                            currentCell._content += "\n" + line;
                        }
                    }
                }
                
                if (currentCell) cells.push(currentCell);
                
                const result = {
                    "titleText": thumbTitle.value.trim(),
                    "titleTexture": thumbUrl.value.trim(),
                    "important": important,
                    "showMark": showMark,
                    "headText": topTitle.value.trim(),
                    "cells": cells
                };
                
                preview.textContent = JSON.stringify(result, null, 4);
            });
            
            clearButton.addEventListener('click', function() {
                if(confirm("确定要清空所有内容吗？")) {
                    inputText.value = "";
                    thumbTitle.value = "";
                    thumbUrl.value = "";
                    topTitle.value = "";
                    preview.textContent = "";
                    saveStateDebounced();
                }
            });

            // 【复制功能】
            copyButton.addEventListener('click', function() {
                const content = preview.textContent;
                if (!content) { alert('请先生成结果'); return; }
                navigator.clipboard.writeText(content).then(() => {
                    alert('已成功复制到剪贴板！');
                }).catch(err => {
                    const textarea = document.createElement('textarea');
                    textarea.value = content;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    alert('已成功复制到剪贴板！');
                });
            });
            
            function getSelectionText() {
                return inputText.value.substring(inputText.selectionStart, inputText.selectionEnd);
            }
            
            function replaceSelection(replacement) {
                const start = inputText.selectionStart;
                const end = inputText.selectionEnd;
                const value = inputText.value;
                inputText.value = value.substring(0, start) + replacement + value.substring(end);
                inputText.selectionStart = inputText.selectionEnd = start + replacement.length;
                inputText.focus();
            }
            
            function wrapSelection(tag) {
                const selectedText = getSelectionText();
                if (!selectedText) { alert('请先选中需要格式化的文本'); return; }
                const startTag = `<${tag}>`;
                const endTag = `</${tag.split(' ')[0]}>`;
                replaceSelection(startTag + selectedText + endTag);
            }
        });
    </script>
</body>
</html>
